from optparse import OptionParser
from collections import Counter

from sklearn.cluster import KMeans

from log import log

import csv
import numpy as np


def set_dataset(row):
    return {
        'name': row[0],
        'type': int(row[1]),
        'feature': np.array(row[2:])
    }


def main(train_file, minimum_cluster, maximum_cluster, output_file):
    dataset = {}
    c_result = {}

    with open(train_file, 'r') as csvfile:
        reader = csv.reader(csvfile, delimiter=',', quoting=csv.QUOTE_MINIMAL)
        for index, row in enumerate(reader):
            if index > 0:
                dataset[index] = set_dataset(row)
                # break
    feature = (np.array([row[1]['feature'] for row in dataset.items()]))
    label = (np.array([row[1]['type'] for row in dataset.items()]))

    best_cluster = {'c_number': 0, 'precision': 0}

    for i in range(minimum_cluster, maximum_cluster+1):
        tp = 0  # true-positive
        fp = 0  # false-positive
        tn = 0  # true-negative
        fn = 0  # true-positive

        kmeans = KMeans(n_clusters=i, random_state=0).fit(feature)
        result = kmeans.labels_.tolist()

        # clustering result check using dicitonary
        for j in range(len(result)):
            if result[j] in c_result:
                c_result[result[j]].append(label[j])
            else:
                c_result[result[j]] = [label[j]]

        for k in range(i):
            try:
                each_c = Counter(c_result[k])  # each cluster bucket
                morb = max(each_c, key=each_c.get)  # malware or benign in each cluster     
                if morb == 0:
                    tp += each_c[0]
                    fp += each_c[1]
                else:  #if morb is 1
                    tp += each_c[1]
                    fp += each_c[0]
            except:
                pass

        precision = tp / (fp + tp)

        log().debug("Running result of {} cluster".format(i))
        log().debug("tp: {} / fp: {}".format(tp, fp))
        log().debug("%d cluster's Precision: %0.4f" %(i, precision))

        if best_cluster['precision'] < precision:
            best_cluster['precision'] = precision
            best_cluster['c_number'] = i

    log().info("##########################################################")
    log().info("Best of the Best cluster: {}".format(best_cluster['c_number']))
    log().info("Precision: {}".format(best_cluster['precision']))
    log().info("##########################################################")


if __name__ == '__main__':

    opt_parser = OptionParser()
    opt_parser.add_option(
        '-c', '--csv', dest='train_file',
        help='csv input feature table.')
    opt_parser.add_option(
        '--min', dest='minimum_cluster', type=int,
        help='the number of minimum cluster (default: 2)')
    opt_parser.add_option(
        '--max', dest='maximum_cluster', type=int,
        help='the number of maximum cluster (default: 3)')
    opt_parser.add_option(
        '--output', dest='output_file',
        help='.csv output filename. silhouette result')

    options, _ = opt_parser.parse_args()

    main(options.train_file, options.minimum_cluster, options.maximum_cluster, options.output_file)
