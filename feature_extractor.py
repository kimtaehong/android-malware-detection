import glob
from os.path import join, dirname, realpath, basename
from pickle import loads
from csv import writer, QUOTE_MINIMAL
from optparse import OptionParser

from androguard.misc import *

from log import log


def analyze_apk_file(apk_file_path: str):
    """Analyze APK file."""
    a, _, _ = AnalyzeAPK(apk_file_path)
    return a.get_permissions()


if __name__ == '__main__':
    opt_parser = OptionParser()
    opt_parser.set_defaults(inmemory=False, debug=False, UseLocalTimezone=True, UseGUI=False)
    opt_parser.add_option('-t', '--train-data--path',
                          dest='train_data_path',
                          help='input train data path')
    options, args = opt_parser.parse_args()
    if options.train_data_path is None:
        opt_parser.print_help()
        exit(-1)
    current_module_path = dirname(realpath(__file__))
    with open(join(current_module_path, 'classifier/features.pkl'), 'rb') as file_object:
        features = loads(file_object.read())
    log().info('load features: {}'.format(features))

    csv_file_object = open('train.csv', 'a+')
    csv_writer = writer(csv_file_object, delimiter=',', quoting=QUOTE_MINIMAL)

    csv_headers = features.copy()
    csv_headers.insert(0, 'name')
    csv_headers.insert(1, 'type')

    csv_writer.writerow(csv_headers)

    malware_data_path = join(options.train_data_path, '1-malware')
    for file in glob.glob('{}/*.vir'.format(malware_data_path))[:300]:
        file_name = basename(file)
        print("analyzing file", file_name)
        apk_permissions = analyze_apk_file(file)
        res={}
        for idx in range(len(features)):
            res[features[idx]]=0

        for idx in range(len(apk_permissions)):
            res[apk_permissions[idx]]=1

        p = [0]*len(features)
        for idx in range(len(features)):
            p[idx] = res[features[idx]]
        print(p)
        p.insert(0, file_name)
        p.insert(1, 1)
        csv_writer.writerow(p)

    normal_data_path = join(options.train_data_path, '0-normal')
    for file in glob.glob('{}/*.vir'.format(normal_data_path))[:300]:
        file_name = basename(file)
        print("analyzing file", file_name)
        apk_permissions = analyze_apk_file(file)
        res={}
        for idx in range(len(features)):
            res[features[idx]]=0

        for idx in range(len(apk_permissions)):
            res[apk_permissions[idx]]=1

        p = [0]*len(features)
        for idx in range(len(features)):
            p[idx] = res[features[idx]]
        print(p)
        p.insert(0, file_name)
        p.insert(1, 0)
        csv_writer.writerow(p)
    log().info('Successfully done:-')
    csv_file_object.close()
