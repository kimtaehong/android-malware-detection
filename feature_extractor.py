from __future__ import print_function
import keras
from optparse import OptionParser
from sklearn.preprocessing import StandardScaler
from keras.models import Model, load_model
from keras.layers import Dense, Dropout
from IPython.terminal.embed import InteractiveShellEmbed
from traitlets.config import Config
import numpy as np
from androguard.core.androconf import *
from androguard.misc import *
from androguard.session import Session
#from model import model_antivirus as md
import pefile
import os
from os.path import join, dirname, realpath

import array
import math
import pickle
from sklearn.externals import joblib
import sys
import argparse
import csv
import glob
#import androlyze
#from antivirus1 import model

from multiprocessing import Pool

from log import log


def analyze_apk_file(apk_file_path: str):
    a, _, _ = AnalyzeAPK(apk_file_path)
    apk_permissions =a.get_permissions()
    return apk_permissions


if __name__ == '__main__':
    current_module_path = dirname(realpath(__file__))
    with open(join(current_module_path, 'classifier/features.pkl'), 'rb') as file_object:
        features = pickle.loads(file_object.read())
    log().info('load features: {}'.format(features))

    csv_file_object = open('train.csv', 'a+')
    csv_writer = csv.writer(csv_file_object, delimiter=',', quoting=csv.QUOTE_MINIMAL)

    csv_headers = features.copy()
    csv_headers.insert(0, 'name')
    csv_headers.insert(1, 'type')

    csv_writer.writerow(csv_headers)

    for file in glob.glob('/Users/bunseokbot/Downloads/1-malware/*.vir')[:300]:
        file_name = os.path.basename(file)
        print("analyzing file", file_name)
        apk_permissions = analyze_apk_file(file)
        res={}
        for idx in range(len(features)):
            res[features[idx]]=0

        for idx in range(len(apk_permissions)):
            res[apk_permissions[idx]]=1

        p = [0]*len(features)
        for idx in range(len(features)):
            p[idx] = res[features[idx]]
        print(p)
        p.insert(0, file_name)
        p.insert(1, 1)
        csv_writer.writerow(p)

    for file in glob.glob('/Users/bunseokbot/Downloads/0-normal/*.vir')[:300]:
        file_name = os.path.basename(file)
        print("analyzing file", file_name)
        apk_permissions = analyze_apk_file(file)
        res={}
        for idx in range(len(features)):
            res[features[idx]]=0

        for idx in range(len(apk_permissions)):
            res[apk_permissions[idx]]=1

        p = [0]*len(features)
        for idx in range(len(features)):
            p[idx] = res[features[idx]]
        print(p)
        p.insert(0, file_name)
        p.insert(1, 0)
        csv_writer.writerow(p)
    log().info('Successfully done:-')
    csv_file_object.close()
